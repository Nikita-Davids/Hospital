@model Hospital.Models.Medication

@{
    Layout = "~/Views/Shared/_LayoutPharmacist.cshtml";
}

<style>
    h1 {
        text-align: center;
        color: #08075F;
        font-weight: bold;
        text-decoration: underline;
    }

    h4 {
        color: #08075F;
        font-weight: bold;
    }

    .btn-link {
        background-color: #08075F;
        color: white;
        border: none;
        padding: 5px 10px;
        text-decoration: none;
        cursor: pointer;
        font-size: 13px;
        float: left;
    }

        .btn-link:hover {
            background-color: #FFDE59;
            border: none;
        }

    .form-border {
        border: 2px solid #ccc;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background-color: #f9f9f9;
    }

    .form-control {
        border-radius: 5px;
    }

    .btn-primary {
        background-color: #08075F;
        border: none;
        color: white;
    }

        .btn-primary:hover {
            background-color: #FFDE59;
        }

    .small-input {
        width: 250px; /* Adjust the width to your liking */
    }

    .shift-right {
        margin-left: 80px; /* Adjust the margin to your liking */
    }

    .text-danger {
        color: red;
    }

    /* Ensure list-group-item and button alignment */
    .list-group-item {
        position: relative; /* Allow absolute positioning of the button */
    }

    .remove-ingredient {
        position: absolute; /* Position the button absolutely within the list item */
        right: 10px; /* Adjust as needed */
        top: 50%; /* Center vertically */
        transform: translateY(-50%); /* Center vertically */
    }

    .text-right {
        text-align: right; /* Aligns the text or elements to the right */
    }
</style>

<h1>Edit Medication</h1>

<hr />
<div class="row">
    <div class="col-md-6 offset-md-3 form-border">
        <form asp-action="EditMedication" asp-route-id="@Model.MedicationId" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="MedicationName" class="control-label"></label>
                <input asp-for="MedicationName" class="form-control" />
                <span asp-validation-for="MedicationName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="DosageForm" class="control-label"></label>
                <select asp-for="DosageForm" class="form-control" asp-items="ViewBag.DosageForms"></select>
                <span asp-validation-for="DosageForm" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Schedule" class="control-label"></label>
                <select asp-for="Schedule" class="form-control">
                    <option value="">Select Schedule</option>
                    <option value="Schedule 1">Schedule 1</option>
                    <option value="Schedule 2">Schedule 2</option>
                    <option value="Schedule 3">Schedule 3</option>
                    <option value="Schedule 4">Schedule 4</option>
                    <option value="Schedule 5">Schedule 5</option>
                    <option value="Schedule 6">Schedule 6</option>
                    <option value="Schedule 7">Schedule 7</option>
                </select>
                <span asp-validation-for="Schedule" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="ReOrderLevel" class="control-label"></label>
                <input asp-for="ReOrderLevel" class="form-control" />
                <span asp-validation-for="ReOrderLevel" class="text-danger"></span>
            </div>

            <!-- Active Ingredients Section -->
            <div class="form-group">
                <label class="control-label">Active Ingredient</label>
                <select id="ingredientDropdown" class="form-control">
                    <option value="">Select Ingredient</option>
                    @foreach (var ingredient in ViewBag.Ingredients as IEnumerable<SelectListItem>)
                    {
                        <option value="@ingredient.Value">@ingredient.Text</option>
                    }
                </select>
                <span asp-validation-for="MedicationActiveIngredients" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="control-label">Strength</label>
                <select id="strengthDropdown" class="form-control">
                    <option value="">Select Strength</option>
                </select>
            </div>
            <br />
            <div class="form-group">
                <button type="button" id="addIngredientButton" class="btn btn-primary">Add Ingredient</button>
                <button type="button" id="saveIngredientButton" class="btn btn-secondary">Save Changes</button>
            </div>
            <br />

            <!-- Combined Ingredients Display -->
            <div class="form-group">
                <label class="control-label">Combined Active Ingredients</label>
                <ul id="ingredientsList" class="list-group">
                    <!-- Existing ingredients will be listed here -->
                </ul>
                <input type="hidden" name="CombinedIngredientsHidden" id="CombinedIngredientsHidden" value="@Model.MedicationActiveIngredients" />
            </div>
            <br />

            <div class="form-group text-right">
                <input type="submit" value="Save Medication" class="btn btn-primary" />
            </div>

            <div class="form-group text-center">
                <a class="btn-link" asp-controller="Pharmacist" asp-action="ViewAddMedication">Back to View</a>
            </div>
        </form>
    </div>
</div>
<br />
<br />
<br />


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            var ingredientStrengths = @Html.Raw(Json.Serialize(ViewBag.IngredientStrengths));
            var existingIngredients = @Html.Raw(Json.Serialize(Model.MedicationActiveIngredients));

            function populateStrengths(ingredientName) {
                var $strengthDropdown = $('#strengthDropdown');
                $strengthDropdown.empty();
                $strengthDropdown.append('<option value="">Select Strength</option>');

                if (ingredientStrengths[ingredientName]) {
                    $.each(ingredientStrengths[ingredientName], function (index, value) {
                        $strengthDropdown.append('<option value="' + value + '">' + value + '</option>');
                    });
                }
            }

            function updateIngredientList() {
                var $ingredientsList = $('#ingredientsList');
                var combinedList = $('#CombinedIngredientsHidden').val().split(', ').filter(Boolean);

                $ingredientsList.empty();
                $.each(combinedList, function (index, item) {
                    $ingredientsList.append('<li class="list-group-item" data-index="' + index + '">' + item + ' <button type="button" class="btn btn-danger btn-sm remove-ingredient" data-index="' + index + '">Remove</button></li>');
                });
            }

            $('#ingredientDropdown').change(function () {
                var ingredientName = $(this).val();
                populateStrengths(ingredientName);
            });

            $('#addIngredientButton').click(function () {
                var ingredientName = $('#ingredientDropdown').val();
                var strength = $('#strengthDropdown').val();
                var combinedIngredients = $('#CombinedIngredientsHidden');
                var combinedList = combinedIngredients.val().split(', ').filter(Boolean);

                if (ingredientName && strength) {
                    var newIngredient = ingredientName + ' (' + strength + ')';
                    if (!combinedList.includes(newIngredient)) {
                        combinedList.push(newIngredient);
                        combinedIngredients.val(combinedList.join(', '));
                        updateIngredientList();
                    }
                }
            });

            $('#saveIngredientButton').click(function () {
                var ingredientName = $('#ingredientDropdown').val();
                var strength = $('#strengthDropdown').val();
                var selectedIndex = $('#ingredientsList .list-group-item.selected').data('index');
                var combinedIngredients = $('#CombinedIngredientsHidden');
                var combinedList = combinedIngredients.val().split(', ').filter(Boolean);

                if (ingredientName && strength) {
                    var updatedIngredient = ingredientName + ' (' + strength + ')';

                    if (selectedIndex !== undefined) {
                        combinedList[selectedIndex] = updatedIngredient;
                        combinedIngredients.val(combinedList.join(', '));
                        updateIngredientList();
                    }
                }
            });

            $('#ingredientsList').on('click', 'li', function () {
                $(this).addClass('selected').siblings().removeClass('selected');
                var index = $(this).data('index');
                var ingredientString = $('#CombinedIngredientsHidden').val().split(', ')[index];
                var parts = ingredientString.split(' (');
                var ingredientName = parts[0];
                var strength = parts[1]?.replace(')', '');

                $('#ingredientDropdown').val(ingredientName);
                populateStrengths(ingredientName);
                $('#strengthDropdown').val(strength);
            });

            $('#ingredientsList').on('click', '.remove-ingredient', function () {
                var index = $(this).data('index');
                var combinedIngredients = $('#CombinedIngredientsHidden');
                var combinedList = combinedIngredients.val().split(', ').filter(Boolean);

                combinedList.splice(index, 1);
                combinedIngredients.val(combinedList.join(', '));
                updateIngredientList();
            });

            // Initialize pre-selected ingredients
            updateIngredientList();
        });
    </script>
}
